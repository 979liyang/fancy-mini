# 登录模块

登录模块暂未与后端逻辑解耦，以下文档为私服中的使用说明，目前仅供参阅。  
如需接入，请参考[登录模块源码](../src/ZZLogin.js)，自行修改使用。    

to do:  
- 将登录模块中与使用方无关的部分单独抽离为通用模块，供第三方直接使用

------

# 登录模块

## 功能
封装了登录过程，并做了静默授权、前后端session有效期不一致、曾经未授权、免并发、自动携带/种植cookie、支持Promise等处理，
      使得登录过程对业务逻辑透明。

## setup
- 引入小程序内部代码库@zz-vc/fancy-mini-zz，参见[readme](../README.md)
- 项目中新建lib/appPlugin.js文件，在其中引入并初始化ZZLogin模块：

```js
import ZZLogin from '@zz-vc/fancy-mini-zz/lib/ZZLogin';
import {registerToThis} from 'fancy-mini/lib/wepyKit';
import wepy from 'wepy';

//登录模块
ZZLogin.install({
  source: 101, //小程序编号
  registerToThisHandler: registerToThis, //注册全局this属性处理函数
  requester(options){ //底层网络API，格式同wx.request
    wepy.request(options);

    //使用了wepy的promisify插件（插件目前不兼容回调形式，需手动回调）
    /*let res = wepy.request(Object.assign({}, options, {success:null, fail: null, complete:null})); //避免以后又兼容回调了造成重复回调，入参中清空回调
    res.then(options.success);
    res.catch(options.fail);
    res.then(options.complete);
    res.catch(options.complete);*/
  }
});

export { //导出部分api，方便lib文件使用
  ZZLogin,
}

```
- app.wpy中引入appPlugin.js: `import './lib/appPlugin';`
- 若项目中此前拷贝了cookie模块，应统一改用npm版， lib/cookie.js：

```js
/**
 * 本模块已收到npm中统一维护，请勿在此处修改
 * 本文件仅作 兼容原有代码 使用
 */
export default from '@zz-vc/fancy-mini-zz/lib/cookie';
```
## 更多配置

```js
import {registerToThis, getCurWepyPage} from 'fancy-mini/lib/wepyKit';
import {errSafe} from 'fancy-mini/lib/decorators';
import {wxResolve} from 'fancy-mini/lib/wxPromise';

ZZLogin.install({
    source: '', //小程序编号，用于区分不同的小程序，由rd指定；登录接口用
    t: '', //同source，cookie中用，未指定时取source值作为t

    /**
     * 已弃用（直接授权改为按钮授权后，拒绝授权导致短期内无法展示弹窗问题不复存在，此配置不再需要）
     * 提示文案，用户曾经拒绝授权导致登录失败时会弹窗提醒并打开授权面板，使其可以重新授权
     * 此处为弹窗提醒的文案内容
     */
    denyTip: '小程序需要您的授权才能提供更好的服务哦~',

    /**
     * 校验函数，根据后端接口返回内容判断后端登录态是否已过期
     * 用于处理前后端session有效时长不一致等问题
     * 该选项以追加的形式进行配置，不会覆盖原有判断逻辑
     * @param resp    接口返回内容
     * @param options 调用接口的参数
     * @return {boolean}  是否登录态失效
     */
    apiAuthFail(resp, options){
      return (
               (resp.errMsg && resp.errMsg.includes('请登录'))
               || (options.url.includes('/aaa/') && resp.respCode == -1)      //平台接口，PPU无效或过期
               || (options.url.includes('/bbb/') && resp.respCode == -2)  //xxx业务接口，PPU无效或过期
               || (options.url.includes('/ccc/') && resp.respCode == -3)  //xxx业务接口，微信session_key无效或过期
             );
    },

    /**
     * 注册到组件上的成员属性/方法列表
     * key为注册到组件实例上的方法名称
     * value为对应的ZZLogin方法名称，保留字'*this'表示ZZLogin自身
     */
    installProps: {
      '$loginCenter': '*this',
      '$login': 'login',
      '$http': 'request',
      '$httpWithLogin': 'requestWithLogin',
      '$logout': 'logout',
      '$reLogin': 'reLogin',
    },

    /**
     * 注册全局this属性处理函数
     */
    registerToThisHandler: registerToThis,

    /**
     * 钩子函数，发请求之前调用
     * @param options 请求参数，格式同wx.request
     * @return {Object} 若有返回值，则以返回值覆盖原参数发出请求，否则使用原参数对象发出请求
     */
    beforeRequest: null,
    /**
     * 底层网络API，格式同wx.request
     */
    requester: wx.request,
    /**
     * 网络异常重试机制，重试成功应resolve(res)，重试失败则reject(res)
     * @param {{
     *    res: Object,
     *    options: Object,
     *    resolve,
     *    reject
     * }}
     */
    requestFailRecoverer({res, options, resolve, reject}){
		//展示无网界面，提示点击重试
		//用户点击图标，开始重试
		ZZLogin.request.call(this, Object.assign({}, options, {success: resolve, fail: reject}));
	},

    /**
     * 登录失败时调用
     * @param {Object} res 登录结果，格式形如：{
     *    code: -3,   //状态码，0为成功
     *    errMsg:'zz login api failed...',  //详细错误日志，debug用
     *    toastMsg: '您的账号存在安全风险，请到58电脑端登录解除'  //（若有）用户话术，提示失败原因
     * }
     */
    loginFailed(res){
      wx.showToast({
        title: res.toastMsg || '登录失败',
        image: '/images/tipfail.png',
        duration: 3000
      });
    },

    /**
     * 入口信息，其中的channel字段会用于后端埋点
     */
    entryInfo: {},

    /**
     * 自定义用户授权逻辑，可用于展示自定义授权弹窗
     * @return {Promise<Object>} 格式同wx.getUserInfo，或返回null使用默认授权逻辑
     */
  	@errSafe
    async userAuthHandler(){
      //自定义弹窗授权
      let page = this instanceof wepy.component ? this.$root : getCurWepyPage(); //获取当前页面实例
      let tips = Object.assign({
        title: '',
        content: '小程序需要您的授权才能提供更好的服务哦~',
        confirmTxt: '知道了'
      }, page.$loginUserAuthTips && page.$loginUserAuthTips()); //若页面有自定义文案，则使用；否则使用默认文案
  
      let userInfoRes = await page.$invoke('PageFrame/AuthModal', 'asyncOpen', { //展示自定义弹窗，并通过button获取用户信息
        title: tips.title,
        content: tips.content,
        buttons: [{
          text: tips.confirmTxt,
          openType: 'getUserInfo',
          clickHandler(btn, ev) {
            return ev.detail;
          },
        }],
      });
  
      return userInfoRes;
    },
  
 	  /**
     * 已弃用（直接授权改为按钮授权后，拒绝授权导致短期内无法展示弹窗问题不复存在，此配置不再需要）
     * 自定义用户拒绝授权处理逻辑
     * @param {string} denyTip 默认提示文案
     * @return {Promise<Object>} 格式同wx.openSetting，或返回null使用默认处理逻辑
     */
    @errSafe
    async userDenyHandler({denyTip}){
      let page = this instanceof wepy.component ? this.$root : getCurWepyPage(); //获取当前页面实例
      let tips = Object.assign({
        title: '',
        content: denyTip,
        confirmTxt: '知道了'
      }, page.$loginUserDenyTips && page.$loginUserDenyTips()); //若页面有自定义文案，则使用；否则使用默认文案
  
      let settingRes = await page.$invoke('PageFrame/AuthModal', 'asyncOpen', { //展示自定义弹窗，并通过button打开&获取授权配置
        title: tips.title,
        content: tips.content,
        buttons: [{
          text: tips.confirmTxt,
          openType: 'openSetting',
          clickHandler(btn, ev){
            return ev.detail;
          },
        }],
      });
  
      return settingRes;
    },
    /**
     * 钩子函数，获取用户授权信息失败时触发
     * @param {string} type  失败类型： deny-用户拒绝授权 | unknown-其它原因
     */
    onUserAuthFailed: null,
    /**
     * 钩子函数，获取用户授权信息成功时触发
     */
    onUserAuthSucceeded: null,
})
``` 

## 使用
配置完成后，登录模块相关方法会统一注册到组件的this中，可在组件实例中通过this.xxx使用登录模块相关功能：
```js
export default class extends wepy.page {
    methods = {
      async onTryLogin(){
        let loginRes = await this.$login();  //登录
        console.log('login succeeded:', loginRes.code==0); //判断是否登录成功

        let uid = this.$loginCenter.zzUserInfo.uid; //获取转转账号信息
        let wxNickname = this.$loginCenter.userInfo.nickName; //获取微信账号信息
      },
      async onTryHttp(){
        let dataRes = await this.$http({ //发起普通http请求
          url: 'https://xxx/getInfoComments',
          data: {
            infoId: '802827304645230593',
            pageNum: 1,
            pageSize: 5,
          }
        });
        console.log('http res:', dataRes, 'normal:', dataRes.respCode==0); //获取接口数据
      },
      async onTryHttpWithLogin(){
        let dataRes = await this.$httpWithLogin({ //发起要求登录的http请求
          url: 'https://xxx/getPersonalHomePage',
          data: {
          }
        });
        console.log('httpWithLogin, res:', dataRes, 'normal:', dataRes.respCode==0); //获取接口数据
      },
    }
}
```
lib文件中也可以直接引入ZZLogin模块达到相同效果，函数名映射关系在“配置”中的installProps属性指定，如按本文档示例配置时：this.$login对应ZZLogin.login、this.$httpWithLogin对应ZZLogin.requestWithLogin：
```js
import {ZZLogin} from './appPlugin';

async function someFunc(){
    let dataRes = await ZZLogin.requestWithLogin({ //发起要求登录的http请求
      url: 'https://xxx/getPersonalHomePage',
      data: {
      }
    });
    console.log('httpWithLogin, res:', dataRes, 'normal:', dataRes.respCode==0); //获取接口数据
}
```

## 更多使用
- 登录：this.$login / ZZLogin.login:

```js
  /**
     *登录
     * @param {Object} options 登录选项
     * @param {Function} options.callback, 兼容起见支持回调，但更建议以Promise方式使用
     * @param {string} options.mode 登录模式
     *    common - 通用模式，适合大部分页面场景
     *    silent - 静默模式，适合免打扰场景：只尝试静默登录，不触发授权弹窗；不管成功失败都不影响页面功能和后续接口调用
     *    force - 强制模式，适合解码场景：刷新微信session，保证解码加密数据时session不过期
     *    silentForce - 静默刷新模式，适合静默解码场景：对老用户，刷新微信session，保证解码加密数据时session不过期；对新用户，不触发授权
     *    
     * @return {Promise<Object>} res 登录结果，格式形如：{
       *    code: -3,   //状态码，0为成功
       *    errMsg:'zz login api failed...',  //详细错误日志，debug用
       *    toastMsg: '您的账号存在安全风险，请到58电脑端登录解除'  //（若有）用户话术，提示失败原因
       * }
     */
    function login(options){ return Promise.resolve(res)}
```

- 发送普通接口请求：this.$http / ZZLogin.request

```js
/**
   * http请求，功能同wx.request，封装了cookie逻辑，并修缮了"POST"使用
   * 兼容起见，支持options中success、fail、complete回调，但更建议以Promise方式使用
   * @param {Object}options 参数，格式同wx.request
   * @param {boolean} requestDetail  是否关注请求详情， true-返回完整请求（状态码、头部、数据等），false-直接返回接口数据
   * @return {Promise} 返回结果，resolve入参为接口返回内容res.data, reject入参为请求结果res
   */
  function request(options, {requestDetail=false}={}){}
```

- 发送要求登录态的接口请求：this.$httpWithLogin / ZZLogin.requestWithLogin：

```js
  /**
    * http请求，封装了登录逻辑，保证登录后再发出请求
    * @param {Object} options 请求参数，格式同wx.request
    * @param {Object} options.loginOpts 登录选项，格式同login函数
    * @return {Promise<Object>} 返回结果，resolve时为接口返回内容, reject时为请求详情
    */
   function requestWithLogin(options){}
```

- 登出：this.$logout / ZZLogin.logout

```js
 /**
   *退出登录
   * @return {Promise<Object>} res 退出登录结果，格式形如：{code:0, errMsg:'ok'}
   */
  function logout(){}
```

- 重新登录： this.$reLogin / ZZLogin.reLogin

```js
/**
   * 重新登录
   * @return {Promise<Object>} 登录结果，格式形如：{code:0, errMsg:'ok'}
   */
  function reLogin(){}
```

- 获取用户信息： this.$loginCenter / ZZLogin

```js
/**
* 获取微信用户信息，格式形如：
{
     "nickName": "",
     "gender": 0,
     "language": "",
     "city": "",
     "province": "",
     "country": "",
     "avatarUrl": ""
 }
注，当用户通过静默授权的形式登录时，此处会返回数据库中存储的用户信息而不会重新向用户弹窗请求访问最新资料，
如需使用最新资料，请自行调用微信相关接口进行获取。
*/
this.$loginCenter.userInfo

/**
* 获取转转账户信息，格式形如：
{
    "uid": "",
    "ppu": "",
    "token": ""
}
注，登录模块不会去获取用户在转转的昵称、头像、加入时间、信用分等个人资料，如需使用请调用后端接口
自行获取
*/
this.$loginCenter.zzUserInfo
```


[返回首页](../README.md)